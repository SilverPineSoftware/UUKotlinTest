name: Publish
permissions: read-all

on:
  create:
    tags:
      - '*.*.*'  # Matches numerical version tags like 1.0.0, 2.1.3, etc.

jobs:

  run-tests:
    uses: SilverPineSoftware/UUKotlinBuild/.github/workflows/uu_tests.yml@main
    with:
      module_path: 'library'
    
  run-instrumented-tests:
    uses: SilverPineSoftware/UUKotlinBuild/.github/workflows/uu_instrumented_tests.yml@main
    with:
      module_path: 'library_instrumented'

#  publish-library:
#    needs: [run-instrumented-tests]
#    uses: SilverPineSoftware/UUKotlinBuild/.github/workflows/uu_library_publish_release.yml@main
#    secrets:
#      MAVEN_CENTRAL_NEXUS_URL: ${{ secrets.MAVEN_CENTRAL_NEXUS_URL }}
#      MAVEN_CENTRAL_SNAPSHOT_URL: ${{ secrets.MAVEN_CENTRAL_SNAPSHOT_URL }}
#      OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
#      OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
#      SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
#      SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
#      SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
#      SONATYPE_STAGING_PROFILE_ID: ${{ secrets.SONATYPE_STAGING_PROFILE_ID }}
#
#  publish-library-instrumented:
#    needs: [run-instrumented-tests]
#    uses: SilverPineSoftware/UUKotlinBuild/.github/workflows/uu_library_publish_release.yml@main
#    with:
#      module_path: 'library_instrumented'
#    secrets:
#      MAVEN_CENTRAL_NEXUS_URL: ${{ secrets.MAVEN_CENTRAL_NEXUS_URL }}
#      MAVEN_CENTRAL_SNAPSHOT_URL: ${{ secrets.MAVEN_CENTRAL_SNAPSHOT_URL }}
#      OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
#      OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
#      SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
#      SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
#      SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
#      SONATYPE_STAGING_PROFILE_ID: ${{ secrets.SONATYPE_STAGING_PROFILE_ID }}
       
  create-release:
    needs: [run-tests, run-instrumented-tests]
#    needs: [publish-library, publish-library-instrumented]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-release-artifacts:
    needs: [run-tests, run-instrumented-tests, create-release]
#    needs: [run-tests, run-instrumented-tests, publish-library, create-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
      
      - name: Upload test results to release
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |

          # Find and zip unit test result artifacts
          for artifact_dir in */; do
            if [[ "$artifact_dir" == *test-results* ]] && [[ "$artifact_dir" != *instrumented* ]]; then
              if [ -d "$artifact_dir" ]; then
                echo "Found unit test artifact directory: $artifact_dir"
                zip -r "library-test-results-${{ github.ref_name }}.zip" "$artifact_dir"
                gh release upload "${{ github.ref_name }}" "library-test-results-${{ github.ref_name }}.zip" --clobber
                UPLOADED_UNIT=true
                break
              fi
            fi
          done
          
          # Find and zip instrumented test result artifacts
          for artifact_dir in */; do
            if [[ "$artifact_dir" == *instrumented-test-results* ]]; then
              if [ -d "$artifact_dir" ]; then
                echo "Found instrumented test artifact directory: $artifact_dir"
                zip -r "library-instrumented-test-results-${{ github.ref_name }}.zip" "$artifact_dir"
                gh release upload "${{ github.ref_name }}" "library-instrumented-test-results-${{ github.ref_name }}.zip" --clobber
                UPLOADED_INSTRUMENTED=true
                break
              fi
            fi
          done

      
      